ARG ARCH=amd64
FROM bayrell/ubuntu:focal-${ARCH}

ARG APT_MIRROR

RUN cd ~; \
	export DEBIAN_FRONTEND='noninteractive'; \
	/etc/apt/apt.mirror/mirror.install.sh; \
	apt-get update; \
	apt-get install -y --no-install-recommends mc less nano wget pv zip \
		unzip supervisor net-tools iputils-ping sudo curl gnupg nginx \
		git ca-certificates python3-pip python3-venv make build-essential \
		docker.io python3-dev; \
	pip3 install mercurial; \
	/etc/apt/apt.mirror/mirror.restore.sh; \
	apt-get clean all; \
	sed -i "s|www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin|www-data:x:33:33:www-data:/data/home:/bin/bash|g" /etc/passwd; \
	ln -sf /dev/stdout /var/log/nginx/access.log; \
	ln -sf /dev/stderr /var/log/nginx/error.log; \
	ln -sf /dev/stdout /var/log/nginx/php_error.log; \
	echo "%wheel ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers; \
	groupadd -r wheel; \
	usermod -a -G wheel www-data; \
	echo 'Ok'